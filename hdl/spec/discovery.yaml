spec_version: 1.0
name: discovery
description: Unified discovery table and CPUID/CAPS pointer model.
revision: v1.1.0
created: 2025-12-24
stable: true

packing:
  endianness: little
  word_bits: 32
  leaf_return_words: 4
  description: Leaf data is returned as four 32-bit words; bit 0 is the LSB of word 0.

identifiers:
  vendor_id_bits: 8
  family_id_bits: 8
  model_id_bits: 8
  stepping_bits: 8
  description: vendor/family/model/stepping are compact identifiers (not strings).

transports:
  - name: CPUID
    applies_to: Z480
    required_tier: P7
    description: CPUID instruction provides pointers to the canonical discovery table.
  - name: CAPS
    applies_to: Z85/Z90
    required_tier: P0
    description: CAPS provides a port/CSR mirror of CPUID leaves using the same IDs and packing.
    model:
      mechanism: index_and_data
      behavior:
        - Write the desired leaf ID to CAPS_INDEX.
        - Read CAPS_DATA0..CAPS_DATA3 to obtain the four return words.
        - Implementations may expose CAPS_* as IO ports, CSRs, or both.
      reserved:
        - CAPS transport-specific addressing is platform-defined; only leaf IDs and packing are architectural.

discovery_table:
  name: CARBON_DISCOVERY_TABLE_V1
  version: 1
  size_bytes: 64
  description: Canonical discovery record; CPUID/CAPS point here for all tier, profile, and pointer data.
  pointer_model:
    pointer_width_bits: 64
    description: Pointers are physical addresses; 0 means absent.
  fields:
    - name: signature
      offset: 0
      width_bytes: 4
      type: u32
      description: ASCII "CDSC" in little-endian (0x43534443).
    - name: table_version
      offset: 4
      width_bytes: 2
      type: u16
      description: Discovery table format version (must be 1).
    - name: table_size
      offset: 6
      width_bytes: 2
      type: u16
      description: Size of the discovery table in bytes (64 for v1).
    - name: cpu_ladder_id
      offset: 8
      width_bytes: 1
      type: u8
      description: CPU ladder ID (TIER_LADDER_Z80).
    - name: fpu_ladder_id
      offset: 9
      width_bytes: 1
      type: u8
      description: FPU ladder ID (TIER_LADDER_AM95).
    - name: presented_cpu_tier
      offset: 10
      width_bytes: 1
      type: u8
      description: Presented CPU tier (P0..P15).
    - name: presented_fpu_tier
      offset: 11
      width_bytes: 1
      type: u8
      description: Presented FPU tier (P0..P15).
    - name: profile_id
      offset: 12
      width_bytes: 1
      type: u8
      description: Profile ID (PROFILE_*).
    - name: reserved0
      offset: 13
      width_bytes: 3
      type: u24
      description: Reserved; must be 0.
    - name: topology_table_ptr
      offset: 16
      width_bytes: 8
      type: u64
      description: Pointer to topology table (0 if not present).
    - name: bdt_ptr
      offset: 24
      width_bytes: 8
      type: u64
      description: Pointer to BIOS Device Table (BDT) base (0 if not present).
    - name: limits_table_ptr
      offset: 32
      width_bytes: 8
      type: u64
      description: Pointer to limits table (queue depths, contexts, vector widths).
    - name: cpu_feature_bitmap_ptr
      offset: 40
      width_bytes: 8
      type: u64
      description: Pointer to CPU feature bitmap.
    - name: fpu_feature_bitmap_ptr
      offset: 48
      width_bytes: 8
      type: u64
      description: Pointer to FPU feature bitmap.
    - name: peripheral_feature_bitmap_ptr
      offset: 56
      width_bytes: 8
      type: u64
      description: Pointer to peripheral/device feature bitmap.

feature_bitmaps:
  word_bits: 32
  words: 4
  description: Feature bitmaps are 128-bit (4x32-bit words).

limits_table:
  name: CARBON_LIMITS_TABLE_V1
  version: 1
  size_bytes: 32
  description: Variable limits for queues, contexts, and vector/tensor widths.
  fields:
    - name: queue_submit_depth
      offset: 0
      width_bytes: 4
      type: u32
      description: Max CAI submit ring depth in entries.
    - name: queue_complete_depth
      offset: 4
      width_bytes: 4
      type: u32
      description: Max CAI completion ring depth in entries.
    - name: contexts
      offset: 8
      width_bytes: 2
      type: u16
      description: Max CAI context count.
    - name: vector_lanes
      offset: 10
      width_bytes: 2
      type: u16
      description: Max vector lanes (0 if not applicable).
    - name: tensor_rank
      offset: 12
      width_bytes: 2
      type: u16
      description: Max tensor rank (0 if not applicable).
    - name: reserved0
      offset: 14
      width_bytes: 2
      type: u16
      description: Reserved; must be 0.
    - name: max_cores
      offset: 16
      width_bytes: 2
      type: u16
      description: Max core count for topology (0 if unknown).
    - name: max_threads
      offset: 18
      width_bytes: 2
      type: u16
      description: Max threads per core (SMT; 0 if unsupported).
    - name: reserved1
      offset: 20
      width_bytes: 12
      type: u96
      description: Reserved; must be 0.

leafs:
  - id: 0x00000000
    name: CPUID_LEAF_VENDOR
    description: Maximum standard leaf and vendor string.
    fields:
      - word: 0
        name: max_standard_leaf
        bits: [15, 0]
      - word: 0
        name: discovery_format_version
        bits: [31, 16]
      - word: 1
        name: vendor_str_0
        bits: [31, 0]
      - word: 2
        name: vendor_str_1
        bits: [31, 0]
      - word: 3
        name: vendor_str_2
        bits: [31, 0]
  - id: 0x00000001
    name: CPUID_LEAF_ID
    description: Vendor ID, family ID, model ID, and stepping.
    fields:
      - word: 0
        name: vendor_id
        bits: [7, 0]
      - word: 0
        name: family_id
        bits: [15, 8]
      - word: 0
        name: model_id
        bits: [23, 16]
      - word: 0
        name: stepping
        bits: [31, 24]
      - word: 1
        name: chip_flags
        bits: [31, 0]
  - id: 0x00000002
    name: CPUID_LEAF_DISCOVERY
    description: Pointer to the canonical discovery table.
    fields:
      - word: 0
        name: discovery_version
        bits: [15, 0]
      - word: 0
        name: discovery_size_bytes
        bits: [31, 16]
      - word: 1
        name: discovery_ptr_lo
        bits: [31, 0]
      - word: 2
        name: discovery_ptr_hi
        bits: [31, 0]
      - word: 3
        name: discovery_flags
        bits: [31, 0]
  - id: 0x00000003
    name: CPUID_LEAF_FEATURES0
    description: CPU feature bitmap word0..3 (legacy mirror of discovery table).
  - id: 0x00000004
    name: CPUID_LEAF_DEVICE_TABLE
    description: Legacy BDT mirror (base pointer; discovery table is canonical).
    fields:
      - word: 0
        name: bdt_format_version
        bits: [15, 0]
      - word: 0
        name: bdt_entry_size_bytes
        bits: [31, 16]
      - word: 1
        name: bdt_entry_count
        bits: [15, 0]
      - word: 1
        name: bdt_header_size_bytes
        bits: [31, 16]
      - word: 2
        name: bdt_base_addr_lo
        bits: [31, 0]
      - word: 3
        name: bdt_base_addr_hi
        bits: [31, 0]
  - id: 0x00000005
    name: CPUID_LEAF_FEATURES1
    description: FPU feature bitmap word0..3 (legacy mirror of discovery table).
  - id: 0x00000006
    name: CPUID_LEAF_FEATURES2
    description: Peripheral/device feature bitmap word0..3 (legacy mirror of discovery table).
  - id: 0x00000010
    name: CPUID_LEAF_CACHE0
    description: Cache descriptor 0 (if present; see topology table for canonical cache IDs).
  - id: 0x00000011
    name: CPUID_LEAF_TOPOLOGY
    description: Legacy topology leaf (discovery table is canonical).
  - id: 0x00000020
    name: CPUID_LEAF_ACCEL0
    description: Accelerator presence descriptor 0 (legacy; discovery table is canonical).
  - id: 0x00000030
    name: CPUID_LEAF_ERRATA0
    description: Errata bitmap 0 (bits 0..127 across words 0..3).

leaf_rules:
  unknown_leaf_behavior: return_zeros
  description: Requests for undefined/reserved leaf IDs return all zeros; software must consult max_standard_leaf.

reserved_leaf_ranges:
  - range: [0x00000007, 0x0000000F]
    description: Reserved for future standard leaves.
  - range: [0x00000012, 0x0000001F]
    description: Reserved for future cache/topology leaves.
  - range: [0x00000021, 0x0000002F]
    description: Reserved for future accelerator descriptor leaves.
  - range: [0x00000031, 0x7FFFFFFF]
    description: Reserved for future standard expansion.
  - range: [0x80000000, 0x8FFFFFFF]
    description: Vendor-specific extended leaves.
  - range: [0x90000000, 0xFFFFFFFF]
    description: Reserved.

feature_sets:
  - id: FEATURESET_CPU
    leaf: CPUID_LEAF_FEATURES0
    description: CPU feature bitmap.
    bits:
      - name: FEAT_MODE_SWITCH
        bit: 0
        description: MODEUP/RETMD mode switching contract implemented.
      - name: FEAT_CSR_NAMESPACE
        bit: 1
        description: Carbon CSR namespace and access model implemented.
      - name: FEAT_FABRIC
        bit: 2
        description: Carbon internal fabric transaction contract implemented.
      - name: FEAT_CPUID
        bit: 3
        description: CPUID instruction transport implemented (Z480 P7).
      - name: FEAT_CAPS
        bit: 4
        description: CAPS transport implemented (Z85/Z90).
      - name: Z85_UNDOC_Z80
        bit: 5
        description: Z85 exposes undocumented Z80 opcodes/flags while presenting as P2.
      - name: Z90_Z180_CLASS
        bit: 6
        description: Z90 is Z180-class while presenting as P3.
      - name: Z380_32BIT_EXTENDED
        bit: 7
        description: Z380 provides 32-bit extended mode while presenting as P6.
      - name: Z480_NATIVE_64
        bit: 8
        description: Z480 provides native 64-bit mode while presenting as P7.
    reserved_bit_ranges:
      - range: [9, 63]
        description: Reserved for base feature growth.
      - range: [64, 127]
        description: Reserved for future feature sets.
  - id: FEATURESET_FPU
    leaf: CPUID_LEAF_FEATURES1
    description: FPU feature bitmap.
    bits:
      - name: AM9512_IEEE_PLUS
        bit: 0
        description: Am9512-plus adds IEEE ports and restored Am9511 functions.
      - name: AM9513_ASYNC_SCALAR
        bit: 1
        description: Am9513 provides async scalar IEEE execution.
      - name: AM9514_VECTOR
        bit: 2
        description: Am9514 provides vector/SIMD math support.
      - name: AM9515_TENSOR
        bit: 3
        description: Am9515 provides matrix/tensor math support.
    reserved_bit_ranges:
      - range: [4, 63]
        description: Reserved for future FPU features.
      - range: [64, 127]
        description: Reserved for future feature sets.
  - id: FEATURESET_PERIPH
    leaf: CPUID_LEAF_FEATURES2
    description: Peripheral/device feature bitmap.
    bits:
      - name: FEAT_CAI
        bit: 0
        description: Carbon Accelerator Interface (CAI) implemented.
      - name: FEAT_BDT
        bit: 1
        description: Board Device Table (BDT) provided for device discovery.
      - name: FEAT_DEVICE_MODEL
        bit: 2
        description: Device capability schema implemented for BDT entries.
      - name: NON_COHERENT_DMA_BASELINE
        bit: 3
        description: DMA is non-coherent by default; software must manage cache maintenance.
      - name: COHERENT_DMA_OPTIONAL
        bit: 4
        description: Reserved for future coherent DMA capability (optional).
    reserved_bit_ranges:
      - range: [5, 63]
        description: Reserved for peripheral feature growth.
      - range: [64, 79]
        description: Reserved for CarbonNet feature namespace.
      - range: [80, 95]
        description: Reserved for CarbonVideo feature namespace.
      - range: [96, 111]
        description: Reserved for CarbonAudio feature namespace.
      - range: [112, 127]
        description: Reserved for CarbonSecure feature namespace.

examples:
  - name: example_cpuid_leaf_table
    description: Small example leaf ID table for documentation.
    rows:
      - leaf: 0x00000000
        name: CPUID_LEAF_VENDOR
      - leaf: 0x00000001
        name: CPUID_LEAF_ID
      - leaf: 0x00000002
        name: CPUID_LEAF_DISCOVERY
      - leaf: 0x00000003
        name: CPUID_LEAF_FEATURES0
