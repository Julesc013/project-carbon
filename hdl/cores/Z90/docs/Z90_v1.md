# Z90 v1.0 â€” Z180-class Core

This directory contains the Z90 core implementation for Project Carbon.

## Architectural contract

- **Presented tier**: P3 (Z180-class) with feature bit `Z90_Z180_CLASS`.
- **Personalities**: P0 8080, P1 8085, P2 Z80, P3 Z180.
- **Reset**: starts in P0. Tier transitions are only via `MODEUP(target, entry)` and `RETMD()`.

## Z180-class meaning (Carbon)

P3 adds the Z180 opcode extensions on top of Z80 semantics. Implemented additions:

- `MLT ss` (`ED 4C/5C/6C/7C`): multiplies the high/low bytes of `ss` into a 16-bit result; flags unchanged.
- `IN0 r,(n)` / `OUT0 (n),r` (`ED 00+r`, `ED 01+r`): immediate 8-bit port, high byte zero.
- `TST r/(HL)` (`ED 04+r`) and `TST n` (`ED 64`): computes `A & operand`, updates flags like AND, `A` unchanged.
- `TSTIO` (`ED 74`): reads port `C`, computes `A & value`, updates flags like AND.
- `SLP` (`ED 76`): implemented as HALT; resumes on interrupt.
- `OTIM/OTIMR/OTDM/OTDMR` (`ED 83/93/8B/9B`): block OUT semantics aligned with Z80 OUTI/OTIR/OUTD/OTDR.

Overlapping opcodes that are Z80 duplicates (NEG/IM1 encodings) keep Z80 meaning in P2 and take the Z180 meaning only in P3.

## Personality gating and illegal opcodes

- P0/P1 restrict IX/IY and Z80-only opcodes; unsupported instructions trap with `CAUSE_ILLEGAL_INSN`.
- P3-only opcodes (IN0/OUT0, TST r, OTIM/OTDM variants) trap when executing in P2 or lower.
- Other undefined Z80 opcodes execute as NOP (no state change).

## Interrupt, R register, and I/O ordering

- Interrupts are sampled at instruction boundaries; IM0/IM1/IM2 follow Z80 semantics.
- R register increments per instruction fetch; high bit preserved.
- I/O cycles use ordered/uncacheable attributes; no speculative I/O.

## Interfaces

- `fabric_if` masters for memory and I/O.
- `csr_if` provides CPUID/CAPS, tier, modeflags, cause/epc, and debug controls.
- `irq_if` delivers INT/NMI.
- `dbg_if` supports halt/step; `cai_if` is present but tied off.

## Not implemented yet

- Z180 on-core peripherals (DMA, timers, serial); provided by system integration.
- Cycle-accurate timing; this core models architectural semantics only.
