# Z85 v1.0 — Z80 Compatibility Core (Contract)

## Scope

Z85 is Project Carbon’s correctness-first Z80-compatible CPU core. It targets the
Z80-derived ladder and presents as a P2 (Z80) device.

Z85 does **not** implement system-level peripherals, banking/MMU, or bus pin timing.
It is a **core**, not a system.

## Tier presentation and MODEUP/RETMD

- Reset starts in **P0 (8080)**.
- P0/P1/P2 are entered via `MODEUP`/`RETMD` only.
- Presentation tier is always **P2 (Z80)**.
- Feature bit **Z85_UNDOC_Z80** is set to advertise undocumented Z80 behavior.
- P3+ tiers are not implemented in Z85; attempts to enter them trap.

## Tier gating policy

- **P0**: 8080 base opcodes only.
- **P1**: 8085 additions (RIM/SIM stubs) plus base opcodes.
- **P2**: full Z80 instruction set including `CB`, `ED`, `DD/FD`, and indexed
  `DD/FD+CB` forms.
- Unsupported opcodes in the active tier trap with `Z85_CAUSE_ILLEGAL_INSN` and
  update `CARBON_CSR_CAUSE`/`CARBON_CSR_EPC`.

## Undocumented behavior policy

Z85 matches widely used Z80 undocumented behavior:

- `SLL` in the `CB` group (including indexed displacement forms)
- IXH/IXL and IYH/IYL register forms where applicable
- X/Y flags (bits 3 & 5) follow Z80 conventions; for indexed `BIT`, X/Y derive
  from the effective address high byte

## Illegal/undefined opcode policy

- Undefined ED opcodes in P2 behave as NOP (no state change other than `R`).
- Invalid `MODEUP/RETMD` sequences trap with mode-switch causes.

## Interrupt sampling policy

Z85 samples interrupts only at **instruction boundaries**.

### irq_if encoding

Z85 uses a single `irq_if` for INT + NMI:

- If `irq_vector` width is **> 8**, the MSB is treated as **NMI indicator**.
- The low 8 bits `irq_vector[7:0]` are the **interrupt byte**:
  - In **IM2**, this is the IM2 vector byte.
  - In **IM0**, this is the injected opcode byte.

### IM0 policy

IM0 executes the injected opcode byte deterministically (no bus-timing modeling).

## Memory and I/O ordering policy

Z85 produces bus transactions through `fabric_if`:

- `mem_if`: memory transactions
- `io_if`: I/O transactions

Properties:

- One outstanding transaction at a time (v1 simplification)
- I/O requests are marked `ORDERED` and `IO_SPACE` via generated fabric attribute masks
- No speculative I/O

## R register policy

Z85 increments the refresh register `R[6:0]` on each **opcode/prefix fetch**:

- increments for prefix bytes (`DD/FD/ED/CB`) and the final opcode byte
- does **not** increment for displacement or immediate data bytes

## Not modeled

- T-state timing or bus pin toggling
- Z180/Z280/Z380/Z480 extensions
- External system peripherals
