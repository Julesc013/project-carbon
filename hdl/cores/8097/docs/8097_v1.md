# 8097 FPU v1.0 (P0 8087-style + P7 turbo scaffold)

## Overview

`fpu_8097` is a fabric-attached floating-point unit that exposes an **x87-like stack model** (8-deep) plus a minimal **P7 regfile mode**. v1.0 is controlled via a CSR window (no full x87 instruction decode in this prompt).

Internal numeric representation is **FP64** for v1.0. Stack semantics (TOP + push/pop) are preserved, but FP80/extended precision is deferred.

## Tier ladder / gating

- Tier ladder uses the x86-derived enums from `hdl/gen/carbon_arch_pkg.sv`.
- Supported tiers in v1.0:
  - **P0**: supported (stack model + basic ops)
  - **P7**: supported (enables turbo RF mode when `MODEFLAG_STRICT==0`)
  - **P1–P6**: not supported; tier writes fault

Turbo is gated by:

`turbo_allowed = (tier == P7) && (MODEFLAG_STRICT == 0)`

## CSR interface

The 8097 uses a dedicated CSR block (see `hdl/spec/csr_map.yaml`, generated into `hdl/gen/carbon_arch_pkg.sv`):

- Identity / mode:
  - `CARBON_CSR_8097_ID` (RO)
  - `CARBON_CSR_8097_TIER` (RW, privileged)
  - `CARBON_CSR_8097_MODEFLAGS` (RW, privileged)
  - `CARBON_CSR_8097_STATUS` (RO): busy/fault/stack state summary
  - `CARBON_CSR_8097_CTRL_WORD` (RW, privileged): x87 control-word subset (RC rounding bits)
  - `CARBON_CSR_8097_STATUS_WORD` (RO): x87 status-word subset (C0/C2/C3, TOP, basic exception summary)

- Memory address for load/store ops:
  - `CARBON_CSR_8097_MEM_ADDR_LO/HI` (RW)

- Stack data path:
  - `CARBON_CSR_8097_PUSH_LO` (WO): stage low 32
  - `CARBON_CSR_8097_PUSH_HI` (WO): stage high 32 and push `{HI,LO}` onto stack
  - `CARBON_CSR_8097_POP_LO` (RO): peek `ST0[31:0]`
  - `CARBON_CSR_8097_POP_HI` (RO): read `ST0[63:32]` and pop (side-effecting read)

- CSR-driven x87-like operations:
  - `CARBON_CSR_8097_CMD` (WO): write triggers an operation on stack/memory

- P7 regfile mode:
  - `CARBON_CSR_8097_RF_INDEX` (RW, privileged): selects `F0..F15`
  - `CARBON_CSR_8097_RF_DATA_LO/HI` (RW, privileged): access selected register
  - `CARBON_CSR_8097_RF_OP` (WO, privileged): executes a regfile operation (P7-only)

## Control word (v1 subset)

Rounding mode uses x87 RC bits `[11:10]`:

- `00` → round-to-nearest (`CARBON_RND_RN`)
- `01` → round-down (`CARBON_RND_RM`)
- `10` → round-up (`CARBON_RND_RP`)
- `11` → round-to-zero (`CARBON_RND_RZ`)

## CSR command opcodes (CARBON_CSR_8097_CMD)

Defined in `hdl/cores/8097/rtl/fpu_8097_pkg.sv`:

- `0x00` NOP
- `0x01` FADD  (`ST0 = ST0 + ST1`)
- `0x02` FSUB  (`ST0 = ST0 - ST1`)
- `0x03` FMUL  (`ST0 = ST0 * ST1`)
- `0x04` FDIV  (`ST0 = ST0 / ST1`)
- `0x05` FSQRT (`ST0 = sqrt(ST0)`)
- `0x06` FCOM  (compare `ST0` vs `ST1`, sets C0/C2/C3)
- `0x07` FCOMP (compare then pop)
- `0x08` FLD_MEM64  (read FP64 from `MEM_ADDR`, push)
- `0x09` FSTP_MEM64 (store `ST0` to `MEM_ADDR`, pop)

## P7 regfile operations (CARBON_CSR_8097_RF_OP)

Encoding (v1):
- `opcode` = bits `[3:0]`
- `dst`    = bits `[7:4]`
- `srcA`   = bits `[11:8]`
- `srcB`   = bits `[15:12]`

Opcodes (see `fpu_8097_pkg.sv`):
- `MOV`:  `dst = srcA`
- `ADD`:  `dst = srcA + srcB`
- `MUL`:  `dst = srcA * srcB`
- `DIV`:  `dst = srcA / srcB`
- `SQRT`: `dst = sqrt(srcA)`

## Memory behavior

`FLD_MEM64` and `FSTP_MEM64` use the fabric `mem_if` and perform two 32-bit transfers (little-endian) at:

- low word: `MEM_ADDR + 0`
- high word: `MEM_ADDR + 4`

## Determinism / accuracy policy (v1)

Arithmetic uses the synthesizable bounded-accuracy helpers in `hdl/cores/Am9513/rtl/am9513_math_pkg.sv` for determinism. This is **not** a fully IEEE-correct x87 implementation; NaN handling and comparisons are deterministic but simplified.

## Deferred / not implemented yet

- Full x87 instruction decode and 8087 binary interface from the 8096 core
- FP80 internal format, tag word, full exception/mask semantics, complete condition code behavior
- Additional x87 ops (transcendentals, integer conversions, etc.)
- CAI integration and async queueing (optional turbo feature)
- Integrated 8096↔8097 coprocessor path (v1 uses CSR-driven control for bring-up tests)

