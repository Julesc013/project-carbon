# Z380 v1.0 â€” Z380-class Core

This directory contains the Z380 core implementation for Project Carbon.

## Architectural contract

- **Presented tier**: P6 (Z380) with feature bit `Z380_32BIT_EXTENDED`.
- **Personalities**: P0 8080, P1 8085, P2 Z80, P3 Z180, P4 eZ80, P5 Z280, P6 Z380.
- **Reset**: starts in P0. Tier transitions are only via `MODEUP(target, entry)` and `RETMD()`.

## P6 mode semantics (v1)

Mode flags are stored in `CARBON_CSR_MODEFLAGS`:
- bit 2: native enable (Z380 opcodes active)
- bit 3: extended address enable (32-bit address with high word)
- bit 4: longword enable (32-bit mul/div path)
- bit 5: 16-bit vector table enable (IM2 uses `Z380_CSR_VEC_BASE`)

Extended addressing:
- When bit 3 is set in P6, memory addresses are formed as
  `{Z380_CSR_ADDR_HI[15:0], addr_low[15:0]}`.
- v1 treats the high word as a fixed segment and does not yet propagate
  carries across the 16-bit low word.

Banked registers:
- A minimal CSR-visible banked register file is provided for future expansion.
- `Z380_CSR_BANK_SEL`, `Z380_CSR_BANK_INDEX`, and `Z380_CSR_BANK_DATA_LO`
  access 2 banks x 4 registers (32-bit each). These are not yet wired into
  instruction decode.

## Z380 native opcodes (ED group)

Active only when native mode is enabled (modeflags bit 2) and tier is P6.

- `ED F8` : `LD A,(SP+d)` (signed 8-bit displacement)
- `ED F9` : `LD (SP+d),A`
- `ED FA` : `LD A,(HL+d)`
- `ED FB` : `LD (HL+d),A`
- `ED FC` : `MUL`
  - word mode: `HL * DE -> DE:HL`
  - longword mode: `(DE:HL) * BC -> DE:HL` (low 32 bits kept)
- `ED FD` : `DIV`
  - word mode: `HL / DE -> HL`, remainder in `DE`
  - longword mode: `(DE:HL) / BC -> DE:HL`, remainder in `BC`
- `ED FE/FF` : reserved, traps as illegal in P6

Flags for MUL/DIV:
- S/Z/P/X/Y from the low byte of the result
- C set on overflow (MUL) or non-zero remainder (DIV)
- N and H cleared

## Interrupts and vectoring

- IM0/IM1/IM2 follow Z80 semantics by default.
- When P6 and modeflags bit 5 are set, IM2 uses a 16-bit vector table:
  `vector_addr = Z380_CSR_VEC_BASE + (vector * 2)`.
- Vector entries are 16-bit little-endian handler addresses.

## Personality gating and illegal opcodes

- P0/P1 restrict IX/IY and Z80-only opcodes; unsupported instructions trap.
- P4/P5 currently behave as Z180+ with deterministic traps for unimplemented
  eZ80/Z280 opcodes.
- P6 traps reserved Z380 ED opcodes (>= `ED F8`) unless implemented and native
  mode is enabled.

## Interfaces

- `fabric_if` masters for memory and I/O.
- `csr_if` provides CPUID/CAPS, tier, modeflags, and Z380 CSRs.
- `irq_if` delivers INT/NMI; `dbg_if` supports halt/step.

## Not implemented yet

- Full eZ80/Z280 instruction coverage.
- 32-bit register file wired into instruction decode.
- Carry propagation across 32-bit address segments.
- Cycle-accurate timing.
